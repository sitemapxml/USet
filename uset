#!/bin/bash

#############################################
# https://github.com/sitemapxml/USet        #
# Author: Виктор Павловић                   #
#         https://github.com/sitemapxml     #
# License: MIT                              #
# Publish date: Aug 2, 2020.                #
# Version: 2.4.0                            #
#############################################

USET_VERSION='3.0.0'

# Load configuration and libraries
source 'config.txt'
source 'libraries/args.sh'

# Read arguments
[ "$#" = 0 ] || source 'includes/arglist.inc.sh'

# Load definied language and if file does not exist revert to en.txt
[ -f "languages/$conf_language.txt" ] && source "languages/$conf_language.txt" || source 'languages/en.txt'
[ -f "languages/welcome/$conf_language.txt" ] && source "languages/welcome/$conf_language.txt" || source 'languages/welcome/en.txt'
[ -f "languages/help/$conf_language.txt" ] && source "languages/help/$conf_language.txt" || source 'languages/help/en.txt'

# Load functions
source 'includes/functions.inc.sh'
source 'includes/input.inc.sh'
source 'includes/install.inc.sh'

case "$1" in
  -h|--help) printf "$lang_help" && exit 0 ;;
  -v|--version) printf "USet version $USET_VERSION\n" && exit 0 ;;
esac

# Turn output text coloring On or Off
[ "$conf_disable_colors" = 'yes' ] && fn_output_coloring_off || fn_output_coloring_on

# Load pre-install script
if [ ! "$conf_disable_preinstall" = 'yes' ]; then
  [ -f 'user/pre-install.sh' ] && source 'user/pre-install.sh'
fi

[ $UID -ne 0 ] && echo "This script must be run as root." && exit 1

# Show welcome screen
[ ! "$conf_skip_welcome" = 'yes' ] && whiptail --title "USet" --scrolltext --msgbox "$lang_welcome" 20 65

# Input data
[ -n "$hostname" ] && printf "hostname already set to ${YELLOW}$hostname${NC}, skipping user input...\n" || fn_input_hostname
[ -n "$rootpass" ] && printf "rootpass already set, skipping user input...\n" || fn_input_rootpass
[ -n "$unixuser" ] && printf "unixuser already set to ${YELLOW}$unixuser${NC}, skipping user input...\n" || fn_input_unixuser
[ -n "$unixpass" ] && printf "unixpass already set, skipping user input...\n" || fn_input_unixpass
[ -n "$mysqlrpass" ] && printf "mysqlrpass already set, skipping user input...\n" || fn_input_mysqlrpass
[ -n "$email" ] && printf "email already set to ${YELLOW}$email${NC}, skipping user input...\n" || fn_input_email
[ -n "$web_server" ] && printf "web_server already set to ${YELLOW}$web_server${NC}, skipping user input...\n" || fn_input_server_type

# Main installation process
[ ! "$skip_interaction" = 'yes' ] && fn_install_continue_msg

fn_update && fn_install_utilities

[ "$web_server" = 'apache' ] && fn_install_apache && fn_install_php_apache
[ "$web_server" = 'nginx' ] && fn_install_nginx && fn_install_php_nginx
[ "$conf_install_mysql" = 'yes' ] && fn_install_mysql
[ "$conf_install_imagemagick" = 'yes' ] && fn_install_imagick
[ "$conf_php_modify_default" = 'yes' ] && fn_php_modify_default
[ "$conf_webmin_install" = 'yes' ] && fn_install_webmin
[ "$web_server" = 'apache' ] && fn_configure_apache
[ "$web_server" = 'nginx' ] && fn_configure_nginx
[ "$conf_create_index" = 'yes' ] && fn_create_index
[ "$conf_create_phpinfo" = 'yes' ] && fn_create_info

# Set hostname, root password and create additional user
fn_configure_system

# Install SSL Certificate
[ "$ssl_install" = 'yes' ] && fn_install_ssl

# Install Adminer, enable UFW and create password backup file
[ "$conf_install_adminer" = 'yes' ] && fn_install_adminer
[ "$conf_enable_ufw" = 'yes' ] && fn_enable_ufw
[ "$conf_create_pass_backup" = 'yes' ] && fn_create_pass_backup

# Show post-installation message and delete history
fn_msg_completed | fn_write_log $conf_logname

# Load post-install script
if [ ! "$conf_disable_postinstall" = 'yes' ]; then
  [ -f 'user/post-install.sh' ] && source 'user/post-install.sh'
fi

fn_delete_history
